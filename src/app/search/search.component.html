<div class="search-container">
  <div class="container">
    <h1>Find Crown Lands Applications</h1>
    <form #f="ngForm" class="search-form ui form" (ngSubmit)="onSubmit()">
      <label for="keywordInput">Enter Crown Land File or Disposition Numbers</label>
      <div class="input-group main-search-field">
        <input class="form-control" type="text" name="keywordInput" id="keywordInput"
            [(ngModel)]="terms.keywords" [disabled]="searching" autofocus/>
        <div class="input-group-btn">
          <!-- prevent searching if input is empty or we're already searching -->
          <button class="btn btn-primary" type="submit" [disabled]="!terms.keywords || searching">
            <i class="spinner rotating" [hidden]="!searching"></i>
            <span>{{searching ? 'Searching...' : 'Find'}}</span>
          </button>
        </div>
      </div>
    </form>
  </div>
</div>

<div class="container">
  <div class="search-results">
    <h2 *ngIf="ranSearch && !searching && count == 0">
      <strong>No result<span *ngIf="count != 1">s</span> found for "{{keywords.length > 0 ? keywords.join(', ') : 'unknown'}}"</strong>
    </h2>
    <h2 *ngIf="ranSearch && !searching && count > 0">
      <strong>{{count}} result<span *ngIf="count != 1">s</span> found for "{{keywords.length > 0 ? keywords.join(', ') : 'unknown'}}"</strong>
    </h2>
    <table class="table" *ngIf="!searching && count > 0">
      <thead>
        <tr>
          <th class="cl-file" name="Crowns Land File Number">CL File</th>
          <th class="disp">Disp. ID</th>
          <th class="client">Client</th>
          <th class="purpose">Purpose/Subpurpose</th>
          <th class="status">Status</th>
          <th class="actions"></th>
        </tr>
      </thead>
      <ng-template ngFor let-item [ngForOf]="groupByResults">
        <tr class="app-details" *ngIf="item.loaded">
          <td class="cl-file">
            <span class="cl-arrow">{{item.properties.CROWN_LANDS_FILE}}</span>
          </td>
          <td>
            <strong>{{item.properties.DISPOSITION_TRANSACTION_SID}}</strong>
          </td>
          <td [innerHTML]="item.app?.client ? (item.app.client | titlecase) : '<em>Client Not Selected</em>'"></td>
          <td>
            {{item.properties.TENURE_PURPOSE | titlecase}} / {{item.properties.TENURE_SUBPURPOSE | titlecase}}
          </td>
          <td>
            {{item.prcStatus || 'Unknown'}}
          </td>
          <td class="actions">
            <button class="btn btn-sm btn-primary" type="button" 
              *ngIf="!item.app" 
              (click)="importProject(item)">
              <i class="material-icons">add</i>
              Create
            </button>
            <div ngbDropdown *ngIf="item.app">
              <button class="btn btn-sm btn-outline-primary" type="button" ngbDropdownToggle>
                Actions
              </button>
              <div class="dropdown-menu" ngbDropdownMenu>
                <button class="list-group-item list-group-item-action" type="button"
                  [routerLink]="['/a', item.app._id]">
                  <i class="material-icons">insert_drive_file</i>
                  View Application
                </button>
                <button class="list-group-item list-group-item-action" type="button"
                  [routerLink]="['/a', item.app._id, 'edit']">
                  <i class="material-icons">edit</i>
                  Edit Details
                </button>
                <button class="list-group-item list-group-item-action" type="button"
                  [routerLink]="['/comments', item.app._id]">
                  <i class="material-icons">mode_comment</i>
                  Review Comments
                </button>
              </div>
            </div>
          </td>
        </tr>
        <tr class="app-comment-details" *ngIf="item.loaded">
          <td colspan="6">
            <span class="comment-info">
              <span *ngIf="item.app?.numComments > 0">
                <strong>
                  <a [routerLink]="['/comments', item.app._id]">{{item.app.numComments}} comments</a>
                </strong>
                &nbsp;-&nbsp;
              </span>
              <span *ngIf="item.app?.cpStatus">
                {{item.app.cpStatus}}
              </span>
              <span *ngIf="item.app?.currentPeriod">
                &nbsp;-&nbsp; {{item.app.currentPeriod.startDate | date:'longDate'}} to {{item.app.currentPeriod.endDate | date:'longDate'}}
                <span *ngIf="item.app.currentPeriod.daysRemaining">
                  &nbsp;({{item.app.currentPeriod.daysRemaining + (item.app.currentPeriod.daysRemaining === 1 ? ' day ' : ' days ') + 'remaining'}})
                </span>
              </span>
              <em class="loading-comment-info" *ngIf="item.app">
                Fetching Comment Info
              </em>
            </span>
          </td>
        </tr>
      </ng-template>
    </table>
  </div>
</div>